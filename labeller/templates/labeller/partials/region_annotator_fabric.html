<div id="{{region.rid}}" class="region_container" style="width:{{region.floor_width}}px; display:flex; flex-direction: column;">
	<div class="region_container_fabric" style="height:{{region.floor_height}}px; width:{{region.floor_width}}px">
		 <canvas id="fabric_canvas" style="position:absolute"></canvas>
	</div>
	<button id="fabric_add_square_button">Add square (m)</button>
	<button id="delete_cell_button">Delete square (/)</button>
	<button id="toggle_circles_button">Toggle circles (,)</button>

	<table>
		<tr>
			<td>
				<input type="checkbox" id="region_complete_seg" name="region_complete_seg" value="region_complete_seg">
				<label for="region_complete_seg">Mark region complete: segmentation</label>
				<br>
			</td>
		</tr><tr>
			<td>
				<input type="checkbox" id="region_complete_classif" name="region_complete_classif" value="region_complete_classif">
				<label for="region_complete_classif">Mark region complete: classification</label><br>
			</td>
		</tr>
	</table>


<!-- 	<button id="test_button">Test Button</button> -->
</div>

{% load static %}

<script src="{% static 'labeller/fabric.min.js' %}"></script>

<script>
var counter = 0;

class RegionLabellerFabric {
	
	static getRegionIDForPage(){
		if ($('.region_container').length < 1) {
			console.log("RegionLabellerFabric:getRegionIDForPage() - No region id found")
			return -1;
		}
		else {
			var rid = $('.region_container').attr('id');
			console.log('rid =', rid);
			return rid;
		}
	}

	static returnObjectToOlDCoordinates(canvas, obj) {
		canvas.remove(obj);

		$.get("/get_cell_json/", {'cid':obj.name}, function(json){
			console.log("Was successful?: " + json['success']);	
	 		if (json['success'] == false) {
	 			console.log("Error in returnObjectToOlDCoordinates");	
	 		}

	 		else if(json['success'] == true) {
				var cell = JSON.parse(json['cell_json'])[0];
				cell = new Cell(cell);
				RegionLabellerFabric.addBoundingBoxFromCell(canvas, cell);
	 		}
		});
	}

	static updateCellLocation (cid, top, left, height, width){
//		console.log('updating cell location', obj);
		$.post("/change_cell_location/", {'cid':cid, 'top':top, 'left':left, 'height':height, 'width':width}, function(json){

		 		if (json['success'] == false) {
		 			console.log("Error in updateCellLocation");	
		 		}
		 		else if(json['success'] == true) {
					var cell = JSON.parse(json['cell_json'])[0];
					// var all_cells = Cell.LoadCellsFromJson(json['all_cells_json']);
					cell = new Cell(cell);
					console.log("cell is", cell);
					Cell.updateCellAfterLocationChange(cell);
					RegionLabellerFabric.updateCircle(cell);
		 		}
	 	});
	 	
	}


	static setupCanvas () {
		var canvas = new fabric.Canvas('fabric_canvas');
	    var canvasHeight = {{region.floor_height}};
	    var canvasWidth = {{region.floor_width}};
	    canvas.setBackgroundImage("{{region.image.url}}", canvas.renderAll.bind(canvas), {
		    // should the image be resized to fit the container?
		    backgroundImageStretch: false
		});

	    canvas.setHeight(canvasHeight);
	    canvas.setWidth(canvasWidth);

	    RegionLabellerFabric.addEventListeners (canvas);


	 	


	 	canvas.on('object:modified', function (e) {
	        var obj = e.target;
	        console.log('action', e.action, e.transform.scaleX, e.transform.scaleY);
	        if (e.action == 'scaleY'){
	        	console.log('scalingY');
	        }
	        if (e.action == 'scaleX') {
	        	console.log('scalingX')
	        }

	        console.log('object modified', e, obj.name);

	        console.log(e.transform);
	        // let obj = options.target;
	    	var boundingRect = obj.getBoundingRect(true);
		    if (boundingRect.left < 0
		        || boundingRect.top < 0
		        || boundingRect.left + boundingRect.width > this.getWidth()
		        || boundingRect.top + boundingRect.height > this.getHeight()) {
		        // obj.left = e.transform.lastX;
		        // obj.top = e.transform.lastY;

		        RegionLabellerFabric.returnObjectToOlDCoordinates(canvas, obj);
		        // obj.left = 150;
		        // obj.top = 100;

		        // obj.left = obj._stateProperties.left;
		        // obj.angle = obj._stateProperties.angle;
		        // obj.scaleX = obj._stateProperties.scaleX;
		        // obj.scaleY = obj._stateProperties.scaleY;
		        // obj.setCoords();
		        // obj.saveState();
 			}
 			else {
 				RegionLabellerFabric.updateCellLocation(obj.name, obj.top, obj.left, obj.height*obj.scaleY, obj.width*obj.scaleX);

 				//RegionLabellerFabric.updateCellLocation(obj);
 			}


 		});

 		fabric.Canvas.prototype.getItemByName = function(name) {
			var object = null,
		    objects = this.getObjects();

			for (var i = 0, len = this.size(); i < len; i++) {
			    if (objects[i].name && objects[i].name === name) {
			    	object = objects[i];
			    	break;
			    }
			}
			return object;
		};

		return canvas;
	}


	static drawBoundingBox(canvas, left, top, width, height, name) {
		var rect = new fabric.Rect({
	        left: left,
	        top: top,
	        strokeWidth: 3,
		    fill: 'transparent',
	        stroke: 'red',
	        lockRotation: true,
	        width: width,
	        height: height,
	   	});
    	rect.name=name;
    	rect.id=name;
    	console.log('creating bounding box', rect.name, rect);
    	canvas.add(rect);

    	rect.on('mousedown', function(e) {
  			console.log('rect event', e, e.target);
  			console.log('rectangle selected', e.target.name);
  			Cell.selectCellByCID(e.target.name);
		});
	}

	static addBoundingBoxFromCell(canvas, cell){
		RegionLabellerFabric.drawBoundingBox(canvas, cell.getLeft(), cell.getTop(),cell.getWidth(), cell.getHeight(), cell.getCID()); 
	}


	static createCellInDatabase(canvas, rid, left, top, width, height){
		$.post("/add_new_cell_box/", {'rid':rid, 'top':top, 'left':left, 'height':height, 'width':width}, function(json){
			console.log("Was successful?: " + json['success']);	
	 		if (json['success'] == false) {
	 			console.log("Error description: " + json['error']);	
	 			alert("Error description: " + json['error']);
	 		}

	 		else if(json['success'] == true) {
				var cell = JSON.parse(json['new_cell_json'])[0];
				// var all_cells = Cell.LoadCellsFromJson(json['all_cells_json']);
				cell = new Cell(cell);
				var new_cell_div = cell.getDivForCellList();
				$('#unlabelled_cells_inline').prepend(new_cell_div);
				Cell.selectCellByCID(cell.getCID())
				RegionLabellerFabric.addBoundingBoxFromCell(canvas, cell);
				RegionLabellerFabric.addNewCircle(cell);
//				RegionLabellerFabric.drawBoundingBox(canvas, left, top, width, height, cell.getCID());
	 		}
		});
	}

	static drawNewBoundingBox(canvas){
		var left = 150; 
		var top = 100;
		var width = 50; 
		var height = 50;
		var rid = RegionLabellerFabric.getRegionIDForPage();
		var cell = RegionLabellerFabric.createCellInDatabase(canvas, rid, left, top, width, height);
		// console.log('drawNewBoundingBox', cell);
		// RegionLabellerFabric.drawBoundingBox(canvas, left, top, width, height, cell.getCID());
    }

    static removeSelectedBox(canvas){
    	console.log('removing rectangle', canvas.getActiveObject().name, canvas.getActiveObject());
    	Cell.deleteCellByCID( canvas.getActiveObject().name);
    	canvas.remove(canvas.getActiveObject());
    }

    static toggleDots(){
    	var temp = $('.hidden_dot')
		$('.dot').addClass('hidden_dot').removeClass('dot');
		temp.removeClass('hidden_dot').addClass('dot');
    }

    static convertTextToBool(text){
    	console.log("convertTextToBool", text, typeof(text));
    	if (text.toLowerCase() == 'true') {return true;}
    	if (text.toLowerCase() != 'false') {
    		console.log("error in convertTextToBool", text);
    	}
    	return false;
    }

    static toggleRegionCompleteSeg(){
    	var rid = RegionLabellerFabric.getRegionIDForPage();
    	var value = $('#region_complete_seg').prop('checked')
    	$.post("/toggle_region_complete_seg/", {'rid':rid, 'value':value}, function(json){
	 		if(json['success'] == true) {
				console.log("toggleRegionCompleteSeg update success");
	 		} else {
	 			console.log("Error in toggleRegionCompleteSeg", rid, value, json);	
	 		}
	 	});
    }

    static toggleRegionCompleteClass(){
    	var rid = RegionLabellerFabric.getRegionIDForPage();
    	var value = $('#region_complete_classif').prop('checked')
    	$.post("/toggle_region_complete_class/", {'rid':rid, 'value':value}, function(json){
	 		if(json['success'] == true) {
				console.log("toggleRegionCompleteSeg update success");
	 		} else {
	 			console.log("Error in toggleRegionCompleteSeg", rid, value, json);	
	 		}
	 	});
    }


    static addEventListeners (canvas) {
		$('#region_complete_seg').prop('checked', 
			RegionLabellerFabric.convertTextToBool('{{region.all_wc_located}}'));

		$('#region_complete_seg').on('click', function(e) {
			RegionLabellerFabric.toggleRegionCompleteSeg();
		});	
		
		$('#region_complete_classif').prop('checked', 
			RegionLabellerFabric.convertTextToBool('{{region.all_wc_classified}}'));
		
		$('#region_complete_classif').on('click', function(e) {
			RegionLabellerFabric.toggleRegionCompleteClass();
		});	

    	$('#fabric_add_square_button').on('click', function(e) {
		    RegionLabellerFabric.drawNewBoundingBox(canvas);
	 	});

    	$('#delete_cell_button').on('click', function(e) {
		    RegionLabellerFabric.removeSelectedBox(canvas);
	 	});

    	$('#toggle_circles_button').on('click', function(e) {
			RegionLabellerFabric.toggleDots();
	 	});

		// $('#test_button').on('click', function(e) {
		// 	RegionLabellerFabric.selectBoxAsActiveFromCID_CANVAS('2182021230439', canvas);
	 // 	});


		window.addEventListener('keydown', (e) => {
			var code = e.code;
			console.log('keydown',typeof code, code);
			if (code == 'KeyM') {
				RegionLabellerFabric.drawNewBoundingBox(canvas);
			}
			if (code == 'Backslash') {
				RegionLabellerFabric.removeSelectedBox(canvas);
			}
			if (code == 'Comma') {
				RegionLabellerFabric.toggleDots();
			}
			if (code == 'KeyG') {
				// var rect = canvas.getItemByName('r0');
				// console.log('deleting', rect);
				// rect.delete();
			}
		});
	}


	static updateCircle(cell) {
		$("#centroid"+cell.getCID()).remove();
		RegionLabellerFabric.addNewCircle(cell);
		Cell.highlightCircle(cell.getCID());
	}

	static addNewCircle(cell) {
		// var newDiv1 = '<span class="dot no_highlight_dot '+cell.cell_type+'" id="centroid'+cell.getCID()+ '" style=" display: inline-block; ';
		if ($('.hidden_dot').length >0){
			var newDiv1 = '<span class="hidden_dot no_highlight_dot '+cell.cell_type+'" id="centroid'+cell.getCID()+ '" style="';			
		}
		else {
			var newDiv1 = '<span class="dot no_highlight_dot '+cell.cell_type+'" id="centroid'+cell.getCID()+ '" style="';
		}

		newDiv1 = newDiv1 + 'position: absolute; top: ' + (cell.y-7) +'px; left: ' + (cell.x-7) + 'px; z-index: 100">';		
		newDiv1 = newDiv1 + '</span>';
		//console.log("NewDiv1=", newDiv1, $(newDiv1));
		$( ".canvas-container" ).append ($(newDiv1));
		$("#centroid"+cell.getCID()).on('click', function() {
			Cell.selectCellByCID(cell.getCID());
			
		});
	}

	//This references a global variable canvas. If there is more than one canvas, it will not work
	static selectBoxAsActiveFromCID (cid){
		console.log("selectBoxAsActiveFromCID canvas", canvas);
		var counter = 0;
		var found = -1;
		canvas.forEachObject(function(obj) {
			if (obj.id == cid) {
				found = counter
				console.log('found', found)
			}
			counter +=1;
		});
		if (found != -1) {
//			console.log('setting new active object', found)
			canvas.setActiveObject(canvas.item(found));
			canvas.renderAll();
		}
	}

}

$ (document).ready(function() {
	canvas = RegionLabellerFabric.setupCanvas();
	if ('{{cells_json}}'!='none') {		
	 	var cells_json = '{{cells_json}}';
	 	var all_cells = Cell.LoadCellsFromJson(cells_json);
//		console.log(all_cells)
		for (var key in all_cells) {
			var cell = all_cells[key];
			RegionLabellerFabric.addBoundingBoxFromCell(canvas, cell);
			RegionLabellerFabric.addNewCircle(cell);
		}
		CellCounter.updateCountsOnPageAJAX('{{region.rid}}');
	}

});

</script>

