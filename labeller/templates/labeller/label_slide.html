{% extends "labeller/base.html" %}
{% load static %}

{% block title %}Label Region{% endblock %}
{% block content %}
<button id="button">Draw Rectangle</button>
<div id="openseadragon1" style="width: 1200px; height: 800px;"></div>



<div id="regions">
<u1>
	{% for region in regions %}
	<p> 
		ID: {{region.id}} &nbsp &nbsp &nbsp &nbsp
		RID: {{region.rid}} &nbsp &nbsp &nbsp &nbsp  
		<img src="{{region.image.url}}" >
	</p>			


	{% empty %}
		<li>No regions have been added yet</li>
	{% endfor %}

</u1></div>


<script src="{% static 'labeller/openseadragon/openseadragon.min.js' %}"></script>

<script type="text/javascript">

    var dzi_path = "{% static 'labeller/images/zoom/' %}" + '{{slide.dzi_path}}' + '.dzi'
    console.log(dzi_path)

    var viewer = OpenSeadragon({
        id: "openseadragon1",
        showNavigator:  true,
        debugMode: false,
        visibilityRatio: 1.0,
        prefixUrl: "{% static 'labeller/openseadragon/images/' %}",
        tileSources: dzi_path
    });

    var drag;
    var selectionMode = false;

    new OpenSeadragon.MouseTracker({
	    element: viewer.element,
	    
	    pressHandler: function(event) {
	      if (!selectionMode) {
	        return;
	      }
	      
	      var overlayElement = document.createElement('div');
	      overlayElement.id = "box1"
	      overlayElement.class = "box_selection"
	      overlayElement.style.border = "4px solid red"
//	      overlayElement.style.background = 'rgba(255, 0, 0, 0)'; 
	      var viewportPos = viewer.viewport.pointFromPixel(event.position);
	      viewer.addOverlay(overlayElement, new OpenSeadragon.Rect(viewportPos.x, viewportPos.y, 0, 0));
      
	      drag = {
	        overlayElement: overlayElement, 
	        startPos: viewportPos
	      };
	    },

	    dragHandler: function(event) {
	      if (!drag) {
	        return;
	      }
      
	      var viewportPos = viewer.viewport.pointFromPixel(event.position);
	      var diffX = viewportPos.x - drag.startPos.x;
	      var diffY = viewportPos.y - drag.startPos.y;
      
	      var location = new OpenSeadragon.Rect(
	        Math.min(drag.startPos.x, drag.startPos.x + diffX), 
	        Math.min(drag.startPos.y, drag.startPos.y + diffY), 
	        Math.abs(diffX), 
	        Math.abs(diffY)
	      );
      
	      viewer.updateOverlay(drag.overlayElement, location);
	    },
    
    	releaseHandler: function(event) {
    		
			// The canvas-click event gives us a position in web coordinates.
		    var webPoint = event.position;

		    // Convert that to viewport coordinates, the lingua franca of OpenSeadragon coordinates.
		    var viewportPoint = viewer.viewport.pointFromPixel(webPoint);

		    // Convert from viewport coordinates to image coordinates.
		    var imagePoint = viewer.viewport.viewportToImageCoordinates(viewportPoint);

		    // Show the results.
		    console.log(webPoint.toString(), viewportPoint.toString(), imagePoint.toString());

			// The canvas-click event gives us a position in web coordinates.
		    var webPoint = event.position;

		    // Convert that to viewport coordinates, the lingua franca of OpenSeadragon coordinates.
		    var viewportPoint = viewer.viewport.pointFromPixel(webPoint);

		    // Convert from viewport coordinates to image coordinates.
		    var imagePoint = viewer.viewport.viewportToImageCoordinates(viewportPoint);

		    // Show the results.
		    console.log(webPoint.toString(), viewportPoint.toString(), imagePoint.toString());

			console.log(viewer.getOverlayById("box1"))

		    drag = null;
		    selectionMode = false;
		    viewer.setMouseNavEnabled(true);
		}
	
	});

document.getElementById('button').addEventListener('click', function() {
  selectionMode = true;
  console.log('button pressed');
  viewer.setMouseNavEnabled(false);
});

    // https://codepen.io/iangilman/pen/qBdabGM


    // https://stackoverflow.com/questions/36006823/openseadragon-selection information on how to return info from selection


    // var selection = viewer.selection({


    // });

</script>


{% endblock content %}

