{% extends "labeller/base.html" %}
{% load static %}

{% block title %}Label Region{% endblock %}
{% block content %}

<script type="text/javascript">
function createRegionDiv(rid, path) {
  new_div = '<p> RID: '+rid+'    '+'<img src="'+path+'" id="region_img_'+rid+'"></p>'
  console.log(new_div);
  return new_div;
}

function fadeRegionInAndOut(rid){
  $('.floating_region').remove()
  imageID = 'region_img_' + rid;
  clone = $('#'+imageID).clone()
  clone.addClass('floating_region')
  console.log(clone)
  clone.click(function() { 
    $(this).fadeOut(2000);
    //$(this).remove()
  });
  $('#regions').prepend(clone)
  $('.floating_region').fadeIn(2000);
  //clone.fadeOut(500);
  //clone.delete();
}

function addNewRegion(sid, x1, y1, x2, y2){
     $.post("/add_new_region/", {'sid':slide_id, 'x1':x1, 'y1':y1, 'x2':x2, 'y2':y2}, function(json){
     console.log("Was successful?: " + json['success'] +' '+ json['rid']+' '+ json['region_path']);
      
      //Add new region to top of regions div
      $('#regions').prepend(createRegionDiv(json['rid'],json['region_path']));
      fadeRegionInAndOut(json['rid'])
    });
 }
</script>

<!-- ID: {{slide.id}} &nbsp &nbsp &nbsp &nbsp -->


<h2 id="slide_banner">Slide</h2>


<div id="openseadragon1" style="width: 100%; height: 700px;"></div>
<p id="slide_info" style="text-align: center;"> SID: {{slide.sid}} &nbsp &nbsp &nbsp &nbsp  <button id="button">Crop New Region</button></p>

<h2 id="regions_banner">Regions</h2>
<div id="regions">
<u1>
  {% for region in regions %}
  <script>
     $('#regions').append(createRegionDiv('{{region.rid}}', '{{region.image.url}}'))
  </script>

  {% empty %}
    <li>No regions have been added yet</li>
  {% endfor %}

</u1></div>


{% endblock content %}

{% block scripts %} 
<script src="{% static 'labeller/openseadragon/openseadragon.min.js' %}"></script>

<script type="text/javascript">
  console.log('static', '{% static media %}')

    var dzi_path = "{% static 'labeller/images/zoom/' %}" + '{{slide.sid}}' + '.dzi';
    var prefix_url = "{% static 'labeller/openseadragon/images/' %}";
    var slide_id = "{{slide.sid}}"

</script>

<script>

// https://codepen.io/iangilman/pen/qBdabGM
// https://stackoverflow.com/questions/36006823/openseadragon-selection information on how to return info from selection

var viewer = OpenSeadragon({
    id: "openseadragon1",
    showNavigator:  true,
    debugMode: false,
    visibilityRatio: 1.0,
    prefixUrl: prefix_url,
    tileSources: dzi_path,
});


var drag;
var selectionMode = false;

new OpenSeadragon.MouseTracker({
    element: viewer.element,
    
    pressHandler: function(event) {
      console.log('Presss handler')
      if (!selectionMode) {
        return;
      }
      
      var overlayElement = document.createElement('div');
      overlayElement.id = "box1"
      overlayElement.class = "box_selection"
      overlayElement.style.border = "4px solid red"
      var viewportPos = viewer.viewport.pointFromPixel(event.position);
      viewer.addOverlay(overlayElement, new OpenSeadragon.Rect(viewportPos.x, viewportPos.y, 0, 0));
      
      imagePointPos = viewer.viewport.viewportToImageCoordinates(viewportPos);
  
      drag = {
        overlayElement: overlayElement, 
        startPos: viewportPos,
        startPosImagePoint: imagePointPos,
        endPosImagePoint: imagePointPos,
      };
    },

    dragHandler: function(event) {
      if (!drag) {
        return;
      }
  
      var viewportPos = viewer.viewport.pointFromPixel(event.position);
      var diffX = viewportPos.x - drag.startPos.x;
      var diffY = viewportPos.y - drag.startPos.y;
  
      var location = new OpenSeadragon.Rect(
        Math.min(drag.startPos.x, drag.startPos.x + diffX), 
        Math.min(drag.startPos.y, drag.startPos.y + diffY), 
        Math.abs(diffX), 
        Math.abs(diffY)
      );
  
      viewer.updateOverlay(drag.overlayElement, location);
      drag.endPosImagePoint = viewer.viewport.viewportToImageCoordinates(viewportPos);

      var webPoint = event.position;
      var viewportPoint = viewer.viewport.pointFromPixel(webPoint);
      var imagePoint = viewer.viewport.viewportToImageCoordinates(viewportPoint);

      console.log(webPoint.toString(), viewportPoint.toString(), imagePoint.toString());
    },



  releaseHandler: function(event) {


    var x1 = drag.startPosImagePoint.x;
    var y1 = drag.startPosImagePoint.y;
    var x2 = drag.endPosImagePoint.x;
    var y2 = drag.endPosImagePoint.y;


    console.log(x1, y1, x2, y2)
    addNewRegion(slide_id, x1, y1, x2, y2)

    
        var height = drag.overlayElement.height;
  //      console.log('release ', x, y, width, height);
        console.log(drag, x1)

        // console.log(drag.overlayElement.getBoundingClientRect())

    // Description of coordinate system
    // https://openseadragon.github.io/examples/viewport-coordinates/


    // var viewportPos = viewer.viewport.pointFromPixel(event.position);

    // // The canvas-click event gives us a position in web coordinates.
   //    var webPoint = event.position;
   //    console.log(webPoint)

   //    webPoint.x = x;
   //    webPoint.y = y;
   //    console.log(webPoint)

   //    // Convert that to viewport coordinates, the lingua franca of OpenSeadragon coordinates.
   //    var viewportPoint = viewer.viewport.pointFromPixel(webPoint);

   //    // Convert from viewport coordinates to image coordinates.
   //    var imagePoint = viewer.viewport.viewportToImageCoordinates(viewportPoint);

   //    // Show the results.
   //    console.log(webPoint.toString(), viewportPoint.toString(), imagePoint.toString());

    //   console.log(viewer.getOverlayById("box1"))

      drag = null;
      selectionMode = false;
      viewer.setMouseNavEnabled(true);
  }

});
if (document.getElementById('button')!=null) {
  document.getElementById('button').addEventListener('click', function() {
    selectionMode = true;
    console.log('button pressed');
    viewer.setMouseNavEnabled(false);
  });
}
  


</script>
{% endblock scripts %}

