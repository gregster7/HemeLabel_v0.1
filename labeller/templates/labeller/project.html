{% extends 'labeller/base2.html' %}
{% load static %}

{% block title %}{{ project.name }}{% endblock %}

{% block content %}

<script src="{% static 'labeller/Cell.js' %}"></script>
<script src="{% static 'labeller/CellCounter.js' %}"></script>
<!-- <script src="{% static 'labeller/CellSummary.js' %}"></script> -->
<script src="{% static 'labeller/Slide.js' %}"></script>
<link rel="stylesheet" href="{% static 'labeller/dropzone-5.7.0/dist/dropzone.css' %}">
<script src="{% static 'labeller/dropzone-5.7.0/dist/dropzone.js' %}"></script>
<script src="{% static 'labeller/Diagnosis.js' %}"></script>


<script>

// My own Dropzone //
Dropzone.options.mySlideDropzone = {
    
    paramName: function() {
      return "file";
    },

    autoProcessQueue: false,
    maxFilesize: 1000,
    parallelUploads: 100,
    uploadMultiple: true,
    timeout: 100000,
    dictDefaultMessage: "Drop slides here to upload",

    init: function() {
      var submitButton = document.querySelector("#upload-btn");
      var mySlideDropzone = this;

      submitButton.addEventListener("click", function() {
        mySlideDropzone.processQueue();
      });

      mySlideDropzone.on("complete", function(file) {
        mySlideDropzone.removeFile(file);

      });

      mySlideDropzone.on("success", function(file, serverResponse) {
        console.log('entering mydropzone.on("success")');
        if (serverResponse['success']) {
          var slides_json = serverResponse['slides_json'];
          var project_id = serverResponse['project_id'];
          var url = window.location.href;
          console.log(url);
          console.log(slides_json);
          var slides = $.parseJSON(slides_json.replace(/&quot;/ig,'"'));
          console.log(slides);
          if (slides.length > 0) {
            $('#no_slide').remove();
          }

          for (var i=0; i<slides.length; i++) {
            console.log(slides[i]);
            var slide = slides[i];
            console.log(slide.fields.name);
            $('#slides').append(getULForSlide(slide.pk, slide.fields.sid, slide.fields.name));
            $('#bigtable_'+slide.fields.sid).hide();
            infoButtonOnClick(slide.fields.sid);
          }
        }
        else {
          console.log('you have failed.');
        }
      });
    }
  };

</script>

<h2>Project: {{ project.name }}</h2>

<!-- Cell Summary -->
<div class="container-fluid justify-content-center slide_box mt-3 mb-3 p-4">
  <div class="container-fluid m-2">
    {% include "labeller/partials/cell_summary2.html" %}
    <!-- <script>
      $('#slide_info_diagnosis_pk_{{diagnosis.pk}}').text('Open cell summary for all slides with {{diagnosis.name}}')
    </script> -->
  </div>

  <div class="container-fluid ml-4">
    Go to Full Cell Reclassification Lists (may load slowly)
    <a href="#" class="btn btn-primary p-1">
      <i class="bi-arrow-right-circle-fill"></i>
    </a>
  </div>
</div>

<!-- Slide Section -->
<h2>Slides ({{ slides|length }})</h2>

  {% for slide in slides %}

  <div class="container-fluid slide_box" style="padding-right: 5px !important; padding-left: 5px !important">
    <div class="container-fluid my-3 pt-2 pb-3 mx-0">

      <!-- Slide Info -->
      {% include "labeller/partials/slide_diagnoses.html" %}

      <!-- Cell Summary -->
      <div class="flex-row" id="slide_cellSummary_sid_{{slide.sid}}"></div>
      <!-- <script>
        var cellSummary = new CellSummary('sid', {{slide.sid}});
        $('#slide_cellSummary_sid_{{slide.sid}}').append(cellSummary.getNewULForSlide());
        cellSummary.addInfoButtonOnClick();
        $('#bigtable_sid_{{slide.sid}}').hide()
    </script> -->
    </div>
  </div>

  {% empty %}
  <div class="container-fluid justify-content-center">
    <h3 style="border-bottom: 0px;">No Slides</h3>
  </div>
  {% endfor %}

  <!-- Upload Slides -->
  <div id="dropzone-wrapper">
    <div class="container-fluid justify-content-center dropzone_box">

      <h3 style="border-bottom: 0px">Upload Slides</h3>

      <form action="{% url 'labeller:project_dropzone_slide' project.id %}" id="my-slide-dropzone" method="POST" enctype="multipart/form-data" class="dropzone js-reference-dropzone">
        {% csrf_token %}
      </form>

      <div class="d-flex flex-row-reverse pt-1 pb-2">
        <button id="upload-btn" type="button" class="btn upload-btn p-2">Add Slides</button>
      </div>
    </div>
  </div>



<!-- User Section -->
<h2>Users ({{project.users.all|length}})</h2>
{% for user in project.users.all %}
  {{user}}
{% empty %}
<p id="no_users">No Users</p>
{% endfor %}

<!-- Region Section -->
<h2>Regions ({{regions|length}})</h2>
{% for slide in project.slides.all %}
  {% for region in slide.region_set.all %}
    {{region}}
  {% endfor %}
{% empty %}
<p id="no_users">No Regions</p>
{% endfor %}

<!-- Cell Section -->
<H2>Cells ({{cells|length}})</H2>
<div class="mb-5"></div>
{% include "labeller/partials/main_lineages_horizontal.html" %}
</div>

<script>

  $(document).ready(function() {
    console.log('project/{{project.id}}: ready');
    var project_id = '{{project.id}}';
    console.log('project_id = ' + project_id);
    // $('#dropzone-wrapper').hide();
  });
  
</script>


{% endblock content %}